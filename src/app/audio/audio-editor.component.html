<mat-toolbar color="primary" class="toolbar" *ngIf="!hideToolbar">
  <span class="logo"><span class="logo-text">NervBox</span> <span class="logo-subtitle">Mixer</span> <span class="alpha-badge">ALPHA</span></span>
  <span class="spacer"></span>

  <!-- Transport Controls (Primary) -->
  <button mat-icon-button (click)="isPlaying() ? pause() : play()" matTooltip="Play/Pause">
    <mat-icon>{{ isPlaying() ? 'pause' : 'play_arrow' }}</mat-icon>
  </button>

  <!-- Project Management -->
  <button mat-button [matMenuTriggerFor]="arrangementMenu" class="arrangement-btn" matTooltip="Arrangements">
    <mat-icon>folder</mat-icon>
    Arrangements
    <mat-icon>arrow_drop_down</mat-icon>
  </button>
  <mat-menu #arrangementMenu="matMenu">
    <button mat-menu-item (click)="newArrangement()">
      <mat-icon>add</mat-icon>
      <span>New Arrangement</span>
    </button>
    <button mat-menu-item (click)="saveArrangement()">
      <mat-icon>save</mat-icon>
      <span>Save Arrangement</span>
    </button>
    <button mat-menu-item (click)="loadArrangement()">
      <mat-icon>folder_open</mat-icon>
      <span>Load Arrangement</span>
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="deleteArrangement()" class="delete-menu-item">
      <mat-icon>delete</mat-icon>
      <span>Delete Arrangement</span>
    </button>
  </mat-menu>

  <!-- Content Creation -->
  <button mat-icon-button (click)="addTrack()" matTooltip="Add track">
    <mat-icon>queue</mat-icon>
  </button>

  <button mat-icon-button (click)="openFileDialog()" matTooltip="Import audio files">
    <mat-icon>file_upload</mat-icon>
  </button>
  <input #fileInput type="file" multiple accept="audio/*" (change)="onFilesSelected($event.target.files)" hidden>

  <button mat-icon-button (click)="toggleSoundBrowser()" matTooltip="Sound Library" 
          [class.active]="showSoundBrowser()">
    <mat-icon>library_music</mat-icon>
  </button>

  <button mat-button [matMenuTriggerFor]="exportMenu" color="accent" class="export-btn">
    <mat-icon>download</mat-icon>
    Export
    <mat-icon>arrow_drop_down</mat-icon>
  </button>
  <mat-menu #exportMenu="matMenu">
    <button mat-menu-item (click)="exportMixdown('mp3')">
      <mat-icon>audiotrack</mat-icon>
      <span>Export as MP3</span>
    </button>
    <button mat-menu-item (click)="exportMixdown('wav')">
      <mat-icon>graphic_eq</mat-icon>
      <span>Export as WAV</span>
    </button>
  </mat-menu>
</mat-toolbar>

<div class="editor" (wheel)="onWheel($event)">
  <div class="tracks">
    <!-- Header with fixed width columns -->
    <div class="tracks-header">
      <div class="head-spacer">
        <span class="time-display">{{ formatDuration(playhead()) }}</span>
      </div>
      <div class="ruler-container">
        <div class="ruler" #timeline (mousedown)="rulerMouseDown($event)">
          <div class="ticks" [style.width.px]="duration() * pxPerSecond()">
            <ng-container *ngFor="let i of getTimelineMarkers()">
              <div class="tick" [style.left.px]="i * pxPerSecond()">
                <span class="tick-label">{{ i }}s</span>
              </div>
            </ng-container>
          </div>
          <div class="playhead-ruler" [style.left.px]="(playhead() * pxPerSecond())"></div>
        </div>
      </div>
    </div>

    <!-- Track heads column -->
    <div class="tracks-heads">
      <div class="track-head" *ngFor="let track of tracks()">
        <div class="track-controls">
          <div class="title">{{ track.name }}</div>
          <div class="track-buttons">
            <button mat-icon-button 
                    class="track-btn" 
                    [class.active]="track.mute"
                    (click)="toggleMute(track)" 
                    matTooltip="Mute">
              <mat-icon>{{ track.mute ? 'volume_off' : 'volume_up' }}</mat-icon>
            </button>
            <button mat-icon-button 
                    class="track-btn" 
                    [class.active]="track.solo"
                    (click)="toggleSolo(track)" 
                    matTooltip="Solo">
              <mat-icon>headset</mat-icon>
            </button>
            <button mat-icon-button class="track-btn delete" (click)="removeTrack(track)" matTooltip="Remove track">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline lanes column -->
    <div class="tracks-lanes">
      <div class="lane" *ngFor="let track of tracks()" #lane 
           (mousedown)="laneMouseDown($event)" 
           (drop)="onDrop($event, track)" 
           (dragover)="onDragOver($event)"
           (dragenter)="onDragEnter($event, track)"
           (dragleave)="onDragLeave($event)"
           [class.drag-over]="dragOverTrack?.id === track.id">
        <div class="clips" [style.width.px]="duration() * pxPerSecond()">
          <div class="clip"
               *ngFor="let clip of track.clips"
               [class.selected]="clip.id === selectedClipId()"
               [class.dragging]="dragState?.id === clip.id"
               [class.trimming]="trimState?.id === clip.id"
               [style.left.px]="clip.startTime * pxPerSecond()"
               [style.width.px]="clip.duration * pxPerSecond()"
               [style.background]="clip.color"
               (mousedown)="clipMouseDown($event, clip)">
            
            <!-- Trim handles -->
            <div class="resize-handle left" 
                 (mousedown)="startTrimming($event, clip, 'start')"
                 *ngIf="clip.id === selectedClipId()">
            </div>
            <div class="resize-handle right" 
                 (mousedown)="startTrimming($event, clip, 'end')"
                 *ngIf="clip.id === selectedClipId()">
            </div>
            
            <div class="clip-content">
              <div class="clip-name">{{ clip.name }}</div>
            </div>
            <div class="clip-duration-bottom">
              <div class="clip-duration">{{ formatDuration(clip.duration) }}</div>
            </div>
            <img *ngIf="clip.waveform" 
                 [src]="clip.waveform" 
                 class="clip-waveform-img"
                 [style.width.px]="clip.duration * pxPerSecond()"
                 [style.object-fit]="'fill'"
                 alt="Waveform">
          </div>
        </div>
        <div class="playhead" [style.left.px]="(playhead() * pxPerSecond())"></div>
      </div>
    </div>
  </div>

  <!-- Sound Browser -->
  <sound-browser *ngIf="showSoundBrowser()"
                 (soundSelected)="onSoundSelected($event)"
                 (browserToggled)="toggleSoundBrowser()">
  </sound-browser>
</div>
